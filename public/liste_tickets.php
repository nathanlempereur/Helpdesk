<?php
    session_start();
    if (! isset($_SESSION['prenom']) || ! isset($_SESSION['nom'])) {
        header("Location: index.php");
        exit;
    }

    // Connexion à la base de données
    $host     = 'localhost';
    $dbname   = 'SupportTickets';
    $username = 'ticket';
    $password = 'btsinfo';

    try {
        $pdo = new PDO("mysql:host=$host;dbname=$dbname;charset=utf8mb4", $username, $password);
        $pdo->setAttribute(PDO::ATTR_ERRMODE, PDO::ERRMODE_EXCEPTION);
    } catch (PDOException $e) {
        die("Erreur de connexion à la base de données : " . $e->getMessage());
    }

    // Récupérer les tickets de l'utilisateur
    $sql = "SELECT
            t.id,
            td.typed AS type_demande,
            t.titre,
            t.description,
            p.priorited AS priorite,
            s.systemd AS systeme,
            sv.serviced AS service,
            st.statut,
            t.date_creation
        FROM tickets t
        JOIN type_demande td ON t.id_demande = td.id_demande
        JOIN priorite p ON t.id_priorite = p.id_priorite
        JOIN systeme s ON t.id_systeme = s.id_systeme
        JOIN services sv ON t.id_service = sv.id_service
        JOIN statuts st ON t.id_statut = st.id_statut
        WHERE t.nom = :nom AND t.prenom = :prenom
        ORDER BY t.date_creation DESC";

    $stmt = $pdo->prepare($sql);
    $stmt->execute([
        ':nom'    => $_SESSION['nom'],
        ':prenom' => $_SESSION['prenom'],
    ]);
    $tickets = $stmt->fetchAll(PDO::FETCH_ASSOC);

    // Organiser les tickets par statut
    $tickets_par_statut = [
        'ouvert'     => [],
        'en cours' => [],
        'fermé'     => [],
        'autres'     => [],
    ];

    foreach ($tickets as $ticket) {
        $statut = strtolower($ticket['statut']);
        if (array_key_exists($statut, $tickets_par_statut)) {
            $tickets_par_statut[$statut][] = $ticket;
        } else {
            $tickets_par_statut['autres'][] = $ticket;
        }
    }
?>
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Mes tickets</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- W3.CSS -->
  <link rel="stylesheet" href="https://www.w3schools.com/w3css/5/w3.css">
  <!-- Google Fonts -->
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <style>
    body, h1, h2, h3, h4, h5, h6 {
      font-family: "Raleway", sans-serif;
    }
    body, html {
      margin: 0; padding: 0;
      height: 100%; line-height: 1.8;
    }
    .bgimg-1 {
      background-position: center;
      background-size: cover;
      background-image: url("../img/fond-index.png");
      min-height: 100%;
    }
    .ticket-container {
      background-color: rgba(255,255,255,0.2);;
      padding: 100px;
      margin: 0 20px;
      width: 1200px;
      border-radius: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      display: flex;
      justify-content: space-between;
    }
    .ticket-column {
      width: 30%;
      padding: 15px;
      box-sizing: border-box;
      border: solid black 1px;
      border-radius: 15px;
      background-color: white;
    }
    .ticket {
      border-bottom: 1px solid #ccc;
      padding: 15px 0;
    }
    .ticket:last-child {
      border-bottom: none;
    }
    .ticket h4 {
      margin: 0;
    }
    .ticket p {
      margin: 5px 0;
    }
    .w3-bar .w3-button {
      padding: 16px;
    }
    .ticket-statut {
      padding: 10px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      text-align: center;
      margin-top: 10px;
    }
    .statut-ouvert {
      background-color: #F44336; /* Rouge */
    }
    .statut-en-attente {
      background-color: #FFC107; /* Jaune */
      color: black;
    }
    .statut-ferme {
      background-color: #4CAF50; /* Vert */
    }
    .section-tickets {
      margin-bottom: 40px;
    }
  </style>
</head>
<body>

  <!-- Navbar -->
  <div class="w3-top">
    <div class="w3-bar w3-crimson w3-card">
      <span class="w3-bar-item w3-left" style="font-size: 20px">
        <i class="fa fa-life-ring"></i> Mes tickets -                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php echo htmlspecialchars($_SESSION['nom'] . ' ' . $_SESSION['prenom']); ?>
      </span>
      <div class="w3-right w3-hide-small" style="margin-top: 5px; margin-right: 5px;">
        <a href="../index.html" class="w3-bar-item w3-button w3-hover-teal">
          <i class="fa fa-home"></i> Accueil
        </a>
        <a href="logout.php" class="w3-bar-item w3-button w3-hover-teal">
          <i class="fa fa-sign-out"></i> Déconnexion
        </a>
        <a href="formulaire_ticket.php" class="w3-bar-item w3-button w3-hover-teal">
          <i class="fa fa-plus"></i> Nouveau ticket
        </a>
      </div>
    </div>
  </div>

  <!-- Liste des tickets -->
  <main class="bgimg-1 w3-display-container w3-grayscale-min"
        style="display: flex; justify-content: center; align-items: flex-start; padding: 150px 0;">
    <div class="ticket-container">
        <!-- Tickets Ouverts -->
        <div class="ticket-column" >
            <h4><i class="fa fa-exclamation-circle"></i> Tickets ouverts</h4>
            <?php if (count($tickets_par_statut['ouvert']) > 0): ?>
<?php foreach ($tickets_par_statut['ouvert'] as $ticket): ?>
                    <div class="ticket">
                        <h4><?php echo htmlspecialchars($ticket['titre']); ?> <small>(<?php echo htmlspecialchars($ticket['type_demande']); ?>)</small></h4>
                        <p><strong>Priorité :</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php echo htmlspecialchars($ticket['priorite']); ?></p>
                        <p><strong>Système :</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <?php echo htmlspecialchars($ticket['systeme']); ?></p>
                        <p><strong>Service :</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php echo htmlspecialchars($ticket['service']); ?></p>
                        <p><strong>Date :</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <?php echo htmlspecialchars($ticket['date_creation']); ?></p>
                        <p><strong>Description :</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php echo nl2br(htmlspecialchars($ticket['description'])); ?></p>
                        <br>
                        <p class="ticket-statut statut-ouvert">Statut :                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php echo htmlspecialchars($ticket['statut']); ?></p>
                        <form method="post" action="formulaire_ticket.php">
                          <input type="hidden" value='<?php echo $ticket['id'] ?>' name="idT" />
                          <input type="hidden" value='<?php echo $ticket['titre'] ?>' name="titre_2" />
                          <input type="hidden" value='<?php echo $ticket['type_demande'] ?>' name="type_demande2" />
                          <input type="hidden" value='<?php echo $ticket['description'] ?>' name="description2" />
                          <input type="hidden" value='<?php echo $ticket['date_creation'] ?>' name="date_creation2" />
                          <input type="hidden" value='<?php echo $ticket['service'] ?>' name="service2" />
                          <input type="hidden" value='<?php echo $ticket['systeme'] ?>' name="systeme2" />
                          <input type="submit" value="Modifier"/>
                        </form>
                    </div>
                <?php endforeach; ?>
<?php else: ?>
                <p>Aucun ticket ouvert.</p>
            <?php endif; ?>
        </div>

        <!-- Tickets en attente -->
        <div class="ticket-column" >
            <h4><i class="fa fa-clock-o"></i> Tickets en attente</h4>
            <?php if (count($tickets_par_statut['en cours']) > 0): ?>
<?php foreach ($tickets_par_statut['en cours'] as $ticket): ?>
                    <div class="ticket">
                        <h4><?php echo htmlspecialchars($ticket['titre']); ?> <small>(<?php echo htmlspecialchars($ticket['type_demande']); ?>)</small></h4>
                        <p><strong>Priorité :</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php echo htmlspecialchars($ticket['priorite']); ?></p>
                        <p><strong>Système :</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <?php echo htmlspecialchars($ticket['systeme']); ?></p>
                        <p><strong>Service :</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php echo htmlspecialchars($ticket['service']); ?></p>
                        <p><strong>Date :</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <?php echo htmlspecialchars($ticket['date_creation']); ?></p>
                        <p><strong>Description :</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php echo nl2br(htmlspecialchars($ticket['description'])); ?></p>
                        <br>
                        <p class="ticket-statut statut-en-attente">Statut :                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php echo htmlspecialchars($ticket['statut']); ?></p>
                    </div>
                <?php endforeach; ?>
<?php else: ?>
                <p>Aucun ticket en attente.</p>
            <?php endif; ?>
        </div>

        <!-- Tickets Fermés -->
        <div class="ticket-column" >
            <h4><i class="fa fa-check-circle"></i> Tickets fermés</h4>
            <?php if (count($tickets_par_statut['fermé']) > 0): ?>
<?php foreach ($tickets_par_statut['fermé'] as $ticket): ?>
                    <div class="ticket">
                        <h4><?php echo htmlspecialchars($ticket['titre']); ?> <small>(<?php echo htmlspecialchars($ticket['type_demande']); ?>)</small></h4>
                        <p><strong>Priorité :</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php echo htmlspecialchars($ticket['priorite']); ?></p>
                        <p><strong>Système :</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <?php echo htmlspecialchars($ticket['systeme']); ?></p>
                        <p><strong>Service :</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php echo htmlspecialchars($ticket['service']); ?></p>
                        <p><strong>Date :</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <?php echo htmlspecialchars($ticket['date_creation']); ?></p>
                        <p><strong>Description :</strong>                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         <?php echo nl2br(htmlspecialchars($ticket['description'])); ?></p>
                        <br>
                        <p class="ticket-statut statut-ferme">Statut :                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 <?php echo htmlspecialchars($ticket['statut']); ?></p>
                    </div>
                <?php endforeach; ?>
<?php else: ?>
                <p>Aucun ticket fermé.</p>
            <?php endif; ?>
        </div>
    </div>
</main>


</body>
</html>
